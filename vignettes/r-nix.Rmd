---
title: "R: NIX for Reproducibility"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R: NIX for Reproducibility}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
pak::pkg_install("rix")
```


# Reproducibility

-   Ability to recover *exactly* the same results from an analysis  

-   Turning our analysis reproducible  
    -   How easy would it be for someone else to rerun the analysis?
    -   How easy would it be to update the project?  
    -   How easy would it be to reuse this code for another project?  
    -   What guarantee do we have the the output is stable through time?  
    
-   Main things influencing an analysis' reproducibility  
    -   Version of R  
    -   Versions of packages used  
    -   Operating system (rare)  
    -   Hardware (quite rare)  

-   Reproducibility is a continuum  
    -   Peng, Roger D. 2011. "Reproducible Research in Computational Science"
    
-   Popular packages for reproducibility  
    -   {renv}
        -   Run `renv::init()` and check the folder for `renv.lock`  
        -   Records, but does not restore the version of R  
        -   Installation of old packages can fail (missing OS-dependencies)  
    -     Docker  
        -   Containerization tool
        -   Build *images* and run *containers*
        -   Docker images:  
            -   Contain all the software and code needed for your project  
            -   Are immutable (cannot be changed at run-time)
            -   Shared on- and offline  
        -   Very useful and widely used  
        -   High entry cost (familiarity with Linux recommended)  
        -   Single point of failure? (what is something happens to Docker in the future)  
        -   Not dealing with reproducibility per se, we're "abusing" Docker in a way  
    -   [Rocker project](https://rocker-project.org/)

# {rix} and Nix

-   Nix package manager  
    -   Package manager: tool to install and manage *packages*  
-   Gold standard of reproducibility: R, R packages and other dependencies must be managed  
-   Nix is a package manager focused on reproducible builds  
-   Nix deals with everything, with one single text file (Nix expression)  
-   Nix expressions *always* evaulate and build  
-   {rix} makes writing Nix expression easy!  
    -   Simply use the provided `rix()` funciton:
    
```{r, echo = TRUE, eval = FALSE}
library(rix)

rix(
  date = "2025-01-27",
  r_pkgs = c('dplyr', 'ggplot2'),
  systm_pkgs = NULL,
  git_pkgs = NULL,
  tex_pkgs = NULL,
  ide = "code",
  project_path = "."
)
```

-   `renv.lock` files can also be used as starting points

```{r, echo = TRUE, eval = FALSE}
renv2nix(
  renv_lock_path = "path/to/original/renv_project/renv.lock",
  project_path = "path/to/rix_project",
  override_r_ver = "4.4.1" # optional
)
```

-   List required R version and packages  
-   Optionally: more system packages, packages hosted on GitHub or LaTeX packages  
-   Optionally: an IDE (RStudio, Radian, VS Code, other)  
-   Work interactively in an (relatively) isolated, project-specific and reproducible environment!  

-   `rix::rix()` generates a `default.nix` file  
-   Build expression using `nix-build` (in terminal) or `rix::nix_build()` from R  
-   "Drop" into the development environment using `nix-shell`  
-   Expression can be generated even without Nix installed (with some caveats)  

-   Can install specific version of packages (write `dplyr@1.0.0`)  
-   Can install packages hosted on GitHub  
-   [Vignettes to get started](https://docs.ropensci.org/rix/articles/)  

-   Need Windows Subsystem for Linux (WSL) in order to use Nix on Windows
